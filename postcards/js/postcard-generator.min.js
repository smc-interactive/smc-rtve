function updateImages(a){bgImg=$("#carousel-cities .active img"),cuguiImg=$("#carousel-cugui .active img"),stampImg=$("#stamps");var b=["sello-cuba","sello-nyc","sello-hollywood","sello-chicago","sello-vegas","sello-barcelona"];countryStampImg=$("#"+b[cityNames.indexOf(city)]),paperImg=$("#paper-texture"),$("<img/>").attr("src",bgImg.attr("src")).load(function(){bgImg.width=this.width,bgImg.height=this.height,$("<img/>").attr("src",cuguiImg.attr("src")).load(function(){cuguiImg.width=this.width,cuguiImg.height=this.height,$("<img/>").attr("src",paperImg.attr("src")).load(function(){paperImg.width=this.width,paperImg.height=this.height,$("<img/>").attr("src",countryStampImg.attr("src")).load(function(){countryStampImg.width=this.width,countryStampImg.height=this.height,$("<img/>").attr("src",stampImg.attr("src")).load(function(){stampImg.width=this.width,stampImg.height=this.height,a()})})})})})}function doTransform(){function a(a,b,c,d,e,f,g){for(var h=b.split(" "),i="",j=0;j<h.length;j++){var k=i+h[j]+" ",l=a.measureText(k),m=l.width;m>e&&j>0?(g&&a.strokeText(i,c,d),a.fillText(i,c,d),i=h[j]+" ",d+=f):i=k}g&&a.strokeText(i,c,d),a.fillText(i,c,d)}ctx.save(),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.translate(canvas.width/2,canvas.height/2),ctx.translate(-canvas.width/2,-canvas.height/2);var b=200,c=20;(canvas.width-b)/2;updateImages(function(){var d=cityNames.indexOf(city);console.log(cities[d]);var e=canvas.width/2,f=canvas.height/2,g=canvas.height*(bgImg.width/bgImg.height);ctx.drawImage(bgImg[0],0,0,bgImg.width,bgImg.height,0,0,g,canvas.height),ctx.drawImage(cuguiImg[0],0,0,cuguiImg.width,cuguiImg.height,5,canvas.height-200-5,200*(cuguiImg.width/cuguiImg.height),200),ctx.drawImage(paperImg[0],0,0,paperImg.width,paperImg.height,g+10,0,canvas.height*(paperImg.width/paperImg.height),canvas.height),ctx.drawImage(countryStampImg[0],0,0,cuguiImg.width,cuguiImg.height,720,10,250*(cuguiImg.width/cuguiImg.height),250),ctx.drawImage(stampImg[0],0,0,cuguiImg.width,cuguiImg.height,680+20*Math.random(),10+30*Math.random(),250*(cuguiImg.width/cuguiImg.height),250),ctx.restore(),ctx.lineWidth=0,ctx.font='12pt "Gloria Hallelujah", cursive',ctx.strokeStyle="#333",ctx.fillStyle="black",ctx.textAlign="left",ctx.lineJoin="round";var h=$("textarea.form-control").val();h+=" - Con cariño, Xavier Cugat",e=g+20,f=100,ctx.save(),a(ctx,h,e,f,b,c),ctx.lineWidth=0,ctx.font='9pt "Courier New", Courier, "Lucida Sans Typewriter", "Lucida Typewriter", monospace',ctx.strokeStyle="#999",ctx.fillStyle="black",ctx.textAlign="left",ctx.lineJoin="round";var h=cities[d].place;e=g+20,f=30,b=200,c=15,ctx.save(),a(ctx,h,e,f,b,c);var h="lab.rtve.es/xaviercugat";e=g+135,f=295,b=600,c=15,ctx.save(),a(ctx,h,e,f,b,c),ctx.lineWidth=7,ctx.font=cities[d].fontStyle,ctx.strokeStyle=cities[d].strokeColor,ctx.fillStyle=cities[d].fillColor,ctx.textAlign="center",ctx.lineJoin="round";var h=cities[d].greeting;cities[d].upperText&&(h=h.toUpperCase()),e=g/2,f=50,b=400,c=25,ctx.save(),a(ctx,h,e,f,b,c,!0)})}function dataURItoBlob(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new Uint8Array(b.length),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([d],{type:c})}function postCanvasToURL(){var b,a=$("#postcardcanvas")[0].toDataURL();b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]),console.log(a)}function shareOnTwitter(){console.log("Sharing on twitter...")}function shareOnFacebook(){}function imageLoader(){var a=new FileReader;a.onload=function(b){img=new Image,img.onload=function(){ctx.drawImage(img,0,0)},img.src=a.result},a.readAsDataURL(fileInput.files[0])}function downloadCanvas(a,b,c){console.log("descarga postcard"),a.href=document.getElementById(b).toDataURL(),a.download=c}function countChar(a){var b=a.value.length;b>=140?(a.value=a.value.substring(0,140),$(".chars").text(0)):$(".chars").text(140-b)}function switchStep(){$("#firstStep").toggle(),$("#secondStep").toggle()}var canvas=document.getElementById("postcardcanvas");ctx=canvas.getContext("2d");var deviceWidth=window.innerWidth;canvasWidth=Math.min(855,deviceWidth-20),canvasHeight=Math.min(300,deviceWidth-20),canvas.width=canvasWidth,canvas.height=canvasHeight;var cityNames=["La Habana","New York","Los Angeles","Chicago","Las Vegas","Barcelona"],city="La Habana",cities=[{name:"La Habana",place:"Teatro Nacional de Cuba, La Habana, República de Cuba",greeting:"Recuerdos de La Habana",fontStyle:'25pt "Yesteryear", cursive',strokeColor:"white",fillColor:"red",upperText:0},{name:"New York",place:"Carnegie Hall, New York, USA",greeting:"Souvenir from New York",fontStyle:'19pt "Diplomata SC", cursive',strokeColor:"white",fillColor:"red",upperText:0},{name:"Los Angeles",place:"Metro Goldwyn Mayer Studios, Beverly Hills, CA, USA",greeting:"Greetings from Hollywood California",fontStyle:'21pt "Yesteryear", cursive',strokeColor:"white",fillColor:"#dc502b",upperText:0},{name:"Chicago",place:"Chez Paree, IL, USA",greeting:"Howdy from Chicago",fontStyle:'22pt "Limelight", cursive',strokeColor:"white",fillColor:"red",upperText:1},{name:"Las Vegas",place:"The Flamingo, Las Vegas, NV, USA",greeting:"Welcome to Las Vegas",fontStyle:'28pt "Yesteryear", cursive',strokeColor:"#FFF",fillColor:"#279dda",upperText:0},{name:"Barcelona",place:"Hotel Ritz, Barcelona, España",greeting:"Recuerdo de Barcelona",fontStyle:'20pt "Diplomata SC", cursive',strokeColor:"white",fillColor:"#d82a11",upperText:1}],bgImg={},cuguiImg={},paperImg={},countryStampImg={},stampImg={};$("#generateButton").click(function(){console.log("generating..."),doTransform(),switchStep()}),$("#editPostcard").click(function(){switchStep()}),$("#shareTwitter").click(function(){console.log("share on Twitter"),shareOnTwitter()}),$("#shareFacebook").click(function(){console.log("share on Facebook"),shareOnFacebook()}),$("#carousel-cities .carousel-control").click(function(){setTimeout(function(){city=$("#carousel-cities .active div.carousel-caption").text().trim(),console.log("update city: "+city),console.log("index: "+cityNames.indexOf(city))},1e3)}),document.getElementById("downloadPostcard").addEventListener("click",function(){downloadCanvas(this,"postcardcanvas","xaviercugat-postcard.png")},!1),countChar(document.getElementById("customText")),$(document).ready(function(){});
